<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å°ç¡®å¹¸ | æ—¶å…‰ç•™è¨€å¢™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #f8fafc;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* ç€‘å¸ƒæµå“åº”å¼è®¾ç½® */
    .masonry-grid {
      column-count: 1;
      column-gap: 1.5rem;
    }

    @media (min-width: 640px) {
      .masonry-grid {
        column-count: 2;
      }
    }

    @media (min-width: 1024px) {
      .masonry-grid {
        column-count: 3;
      }
    }

    @media (min-width: 1280px) {
      .masonry-grid {
        column-count: 4;
      }
    }

    .break-inside-avoid {
      break-inside: avoid;
    }

    .img-grid-1 {
      grid-template-columns: 1fr;
    }

    .img-grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .img-grid-3 {
      grid-template-columns: 1fr 1fr;
    }

    .img-grid-3 img:first-child {
      grid-column: span 2;
    }

    .img-grid-4 {
      grid-template-columns: 1fr 1fr;
    }

    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.3s ease;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }

    .pop-enter-active,
    .pop-leave-active {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pop-enter-from,
    .pop-leave-to {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }

    .list-move,
    .list-enter-active,
    .list-leave-active {
      transition: all 0.5s ease;
    }

    .list-enter-from,
    .list-leave-to {
      opacity: 0;
      transform: translateY(30px);
    }

    .list-leave-active {
      position: absolute;
    }

    /* è¿›åº¦æ¡åŠ¨ç”» Keyframes - è§£å†³è¿›åº¦æ¡ä¸åŠ¨çš„é—®é¢˜ */
    @keyframes progress-grow {
      from {
        width: 0%;
      }

      to {
        width: 100%;
      }
    }

    .animate-progress-bar {
      animation: progress-grow 60s linear forwards;
    }
  </style>
</head>

<body>

  <div id="app" class="min-h-screen flex flex-col">

    <header
      class="bg-white/95 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm transition-all duration-300">
      <div
        class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8 py-3 md:h-20 md:py-0 relative flex flex-col md:flex-row items-center justify-between gap-3 md:gap-0">

        <div class="w-full md:w-auto flex items-center justify-between md:hidden mb-1">
          <div class="flex items-center gap-2">
            <div
              class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-500 to-indigo-500 flex items-center justify-center text-white text-sm shadow-lg shadow-pink-200/50">
              <i class="fa-solid fa-heart"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">å°ç¡®å¹¸</h1>
          </div>

          <button @click="toggleAutoRefresh"
            class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border"
            :class="isAutoRefresh ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-50 text-gray-500 border-gray-200'">
            <i :class="isAutoRefresh ? 'fa-solid fa-circle-pause' : 'fa-solid fa-circle-play'"></i>
            {{ isAutoRefresh ? 'æ’­æ”¾ä¸­' : 'è‡ªåŠ¨æ’­æ”¾' }}
          </button>
        </div>

        <div class="flex items-center gap-2 w-full md:w-auto md:flex-1 md:max-w-md z-10">
          <div
            class="relative flex-grow md:flex-grow-0 md:w-64 transition-all focus-within:w-full md:focus-within:w-80">
            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
            <input v-model="searchQuery" @input="resetPagination" type="text" placeholder="æœç´¢è®°å¿†..."
              class="w-full pl-9 pr-4 py-2 bg-gray-100/80 border border-transparent focus:bg-white focus:border-indigo-500 rounded-full text-sm transition-all outline-none shadow-inner">
          </div>

          <button @click="toggleImageOnly"
            class="w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-full transition-all border"
            :class="onlyHasImage ? 'bg-indigo-50 text-indigo-600 border-indigo-200 shadow-sm' : 'bg-white text-gray-400 border-gray-200 hover:bg-gray-50'"
            title="åªçœ‹æœ‰å›¾çš„å†…å®¹">
            <i :class="onlyHasImage ? 'fa-solid fa-image' : 'fa-regular fa-image'"></i>
          </button>

          <button @click="manualRefresh"
            class="md:hidden w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-500 active:bg-gray-100">
            <i class="fa-solid fa-shuffle"></i>
          </button>
        </div>

        <div
          class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden md:flex flex-col items-center justify-center z-0 pointer-events-none select-none">
          <div class="flex items-center gap-2 mb-1">
            <div
              class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-500 to-indigo-500 flex items-center justify-center text-white text-sm shadow-lg shadow-pink-200/50">
              <i class="fa-solid fa-heart"></i>
            </div>
            <h1
              class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 tracking-tight">
              å°ç¡®å¹¸</h1>
          </div>
          <p class="text-[10px] text-gray-400 tracking-widest uppercase">Memory Wall</p>
        </div>

        <div class="hidden md:flex items-center justify-end gap-4 z-10 flex-1">
          <div
            class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200/50 hover:bg-white transition-colors">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <span class="text-xs font-medium" :class="isAutoRefresh ? 'text-indigo-600' : 'text-gray-400'">
                <i class="fa-solid fa-infinity mr-1"></i>è‡ªåŠ¨è½®æ’­
              </span>
              <div class="relative">
                <input type="checkbox" v-model="isAutoRefresh" @change="toggleAutoRefresh" class="sr-only">
                <div class="w-9 h-5 bg-gray-200 rounded-full shadow-inner transition-colors duration-300"
                  :class="{ '!bg-green-500': isAutoRefresh }"></div>
                <div
                  class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full shadow transition-transform duration-300"
                  :class="{ 'translate-x-4': isAutoRefresh }"></div>
              </div>
            </label>
          </div>

          <button @click="manualRefresh"
            class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all border border-transparent hover:border-indigo-100"
            title="æ‰‹åŠ¨æ¢ä¸€æ‰¹">
            <i class="fa-solid fa-shuffle text-sm"></i>
          </button>

          <button @click="loadCSV(true)"
            class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all border border-transparent hover:border-indigo-100"
            title="é‡æ–°è¯»å–æ–‡ä»¶">
            <i class="fa-solid fa-rotate-right text-sm"></i>
          </button>
        </div>
      </div>

      <div class="absolute bottom-0 left-0 h-[2px] bg-green-500 w-full" v-if="isAutoRefresh && showProgressBar">
        <div class="h-full bg-green-500 animate-progress-bar"></div>
      </div>
    </header>

    <div v-if="showFilePicker" class="max-w-7xl mx-auto px-4 py-4 w-full">
      <div class="bg-red-50 border border-red-100 rounded-xl p-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3 text-red-700">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <span class="text-sm">æ— æ³•è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹© datacvs.csvï¼š</span>
        </div>
        <input type="file" accept=".csv" @change="handleFileUpload"
          class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200 cursor-pointer">
      </div>
    </div>

    <main class="flex-grow w-full max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
      <div class="masonry-grid relative min-h-[50vh]">
        <transition-group name="list">
          <div v-for="msg in displayedList" :key="msg.id" class="break-inside-avoid mb-4 sm:mb-6">
            <div
              class="bg-white rounded-2xl shadow-sm hover:shadow-xl border border-gray-100 overflow-hidden transition-all duration-300 group cursor-pointer flex flex-col"
              @click="openDetail(msg)">

              <div v-if="msg.images && msg.images.length > 0" class="grid gap-0.5 overflow-hidden bg-gray-100"
                :class="`img-grid-${Math.min(msg.images.length, 4)}`" @click.stop>
                <div v-for="(img, index) in msg.images.slice(0, 4)" :key="index"
                  class="relative aspect-square overflow-hidden bg-gray-200" @click="openLightbox(msg.images, index)">
                  <img :src="img" @error="handleImgError($event)" loading="lazy"
                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-500 cursor-zoom-in">
                  <div v-if="index === 3 && msg.images.length > 4"
                    class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold text-lg backdrop-blur-sm pointer-events-none">
                    +{{ msg.images.length - 4 }}</div>
                </div>
              </div>

              <div class="p-4 sm:p-5 flex-grow flex flex-col">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <h3
                    class="font-bold text-gray-800 text-base sm:text-lg leading-tight group-hover:text-indigo-600 transition-colors line-clamp-1">
                    {{ msg.title || 'æ— æ ‡é¢˜' }}</h3>
                  <span v-if="msg.isNew"
                    class="bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap">NEW</span>
                </div>
                <p class="text-gray-600 text-sm leading-relaxed line-clamp-4 text-justify mb-4 break-words">{{
                  msg.content }}</p>
                <div
                  class="mt-auto pt-3 border-t border-gray-50 flex items-center justify-between text-xs text-gray-400 font-mono">
                  <span class="bg-gray-100 px-2 py-1 rounded text-gray-500 font-medium">No.{{ msg.id }}</span>
                  <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> {{ msg.displayTime }}</span>
                </div>
              </div>
            </div>
          </div>
        </transition-group>
      </div>

      <div ref="loadSentinel"
        class="w-full py-8 text-center text-gray-400 text-sm flex items-center justify-center gap-2">
        <span v-if="isAutoRefresh" class="text-green-600"><i class="fa-solid fa-circle-play mr-1"></i>è‡ªåŠ¨è½®æ’­ä¸­
          (æ¯60ç§’æ›´æ–°)</span>
        <span v-else-if="hasMore"><i class="fa-solid fa-circle-notch fa-spin"></i> æ­£åœ¨åŠ è½½æ›´å¤šå›å¿†...</span>
        <span v-else>â€”â€” å…± {{ totalFilteredCount }} æ¡å›å¿† â€”â€”</span>
      </div>

      <div v-if="totalFilteredCount === 0" class="text-center py-20 text-gray-400">
        <i class="fa-regular fa-folder-open text-4xl mb-4 text-gray-300"></i>
        <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹...</p>
      </div>
    </main>

    <transition name="fade">
      <div v-if="currentMsg"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm"
        @click.self="closeDetail">
        <transition name="pop" appear>
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="px-5 sm:px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
              <div class="flex items-center gap-3">
                <span
                  class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm shadow-indigo-200">No.{{
                  currentMsg.id }}</span>
                <span class="text-gray-400 text-xs">{{ currentMsg.fullTime }}</span>
              </div>
              <button @click="closeDetail"
                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-400 hover:text-gray-700 transition-colors"><i
                  class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5 sm:p-6 overflow-y-auto custom-scrollbar">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">{{ currentMsg.title }}</h2>
              <p class="text-gray-700 leading-7 whitespace-pre-wrap mb-6 text-justify text-base sm:text-lg break-words">
                {{ currentMsg.content }}</p>
              <div v-if="currentMsg.images.length > 0" class="space-y-4">
                <img v-for="(img, idx) in currentMsg.images" :key="idx" :src="img" @error="handleImgError($event)"
                  loading="lazy"
                  class="w-full rounded-xl shadow-sm border border-gray-100 cursor-zoom-in hover:shadow-md transition-all"
                  @click="openLightbox(currentMsg.images, idx)">
              </div>
            </div>
          </div>
        </transition>
      </div>
    </transition>

    <transition name="fade">
      <div v-if="lightboxImages.length"
        class="fixed inset-0 z-[60] bg-black/95 flex flex-col justify-center items-center" @click.self="closeLightbox">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white z-50 p-2 text-2xl"
          @click="closeLightbox"><i class="fa-solid fa-times"></i></button>
        <div class="relative w-full h-full flex items-center justify-center p-4">
          <img :src="lightboxImages[currentLightboxIndex]" @error="handleImgError($event)"
            class="max-w-full max-h-full object-contain shadow-2xl">
          <button v-if="lightboxImages.length > 1" @click.stop="prevImage"
            class="absolute left-4 bg-white/10 hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center backdrop-blur transition-all"><i
              class="fa-solid fa-chevron-left"></i></button>
          <button v-if="lightboxImages.length > 1" @click.stop="nextImage"
            class="absolute right-4 bg-white/10 hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center backdrop-blur transition-all"><i
              class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div class="absolute bottom-8 text-white/80 font-mono bg-white/10 px-4 py-1 rounded-full text-sm backdrop-blur">
          {{ currentLightboxIndex + 1 }} / {{ lightboxImages.length }}</div>
      </div>
    </transition>

  </div>

  <script id="csv-embed" type="text/plain">id,æ ‡é¢˜,æ—¥æœŸ,ç•™è¨€,å›¾ç‰‡,çŠ¶æ€,æ˜¯å¦æœ‰å›¾
20251203001,æ¸©æš–,2025/12/03 09:31,å¸Œæœ›æœ‰ä¸€å¥èƒ½è®©ä½ æˆ–ä½ æƒ³ç¥ç¦çš„äººæ„Ÿåˆ°æ¸©æš– ğŸŒ¸,7å¤ªä¹™_çˆ±ç»™ç½‘_aigei_com.png,å¯å±•ç¤º,1
20251203002,å¥½å¥½åƒé¥­,2025/12/03 09:31,ä»Šå¤©æœ‰å¥½å¥½åƒé¥­å—ï¼Ÿè®°å¾—ç…§é¡¾å¥½è‡ªå·±ã€‚,,å¯å±•ç¤º,0
20251203003,åœä¸‹è„šæ­¥,2025/12/03 09:31,ç”Ÿæ´»æˆ–è®¸å¿™ç¢Œï¼Œä½†åˆ«å¿˜äº†åœä¸‹è„šæ­¥ï¼Œæ„Ÿå—å¾®é£å’Œèº«è¾¹çš„å°ç¡®å¹¸ã€‚,"7å¤ªä¹™_çˆ±ç»™ç½‘_aigei_com.png,wechat_2025-11-12_152347_145.png",å¯å±•ç¤º,1
    </script>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted, nextTick } = Vue;

    createApp({
      setup() {
        const allRawMessages = ref([]);
        const filteredAllMessages = ref([]);
        const displayedList = ref([]);
        const searchQuery = ref('');
        const onlyHasImage = ref(false);
        const showFilePicker = ref(false);
        const loadSentinel = ref(null);

        // è½®æ’­æ§åˆ¶
        const isAutoRefresh = ref(false);
        let autoRefreshTimer = null;
        const showProgressBar = ref(false); // ç”¨äºå¼ºåˆ¶åˆ·æ–°DOMæ¥å®ç°è¿›åº¦æ¡é‡ç½®

        const PAGE_SIZE_INIT = 30;
        const PAGE_SIZE_MORE = 10;
        const currentLimit = ref(PAGE_SIZE_INIT);

        // --- åŸºç¡€é€»è¾‘ ---
        const shuffleArray = (array) => {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        };

        const formatRelativeTime = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          const now = new Date();
          if (isNaN(date.getTime())) return dateStr;
          const diffMs = now - date;
          const diffHour = diffMs / (1000 * 60 * 60);
          const diffDay = diffHour / 24;

          if (diffMs < 0) return dateStr.split(' ')[0];
          if (diffHour < 1) return 'åˆšåˆš';
          else if (diffHour < 24) return Math.floor(diffHour) + 'å°æ—¶å‰';
          else if (diffDay <= 30) return Math.floor(diffDay) + 'å¤©å‰';
          else return dateStr.split(' ')[0];
        };

        const parseCSV = (text) => {
          const rows = []; let headers = [];
          let i = 0, field = '', row = [], inQuotes = false;
          while (i < text.length) {
            const c = text[i++];
            if (inQuotes) {
              if (c === '"') { if (text[i] === '"') { field += '"'; i++; } else { inQuotes = false; } } else { field += c; }
            } else {
              if (c === '"') { inQuotes = true; } else if (c === ',') { row.push(field); field = ''; } else if (c === '\n') { row.push(field); field = ''; rows.push(row); row = []; } else if (c !== '\r') { field += c; }
            }
          }
          if (field || row.length) { row.push(field); rows.push(row); }
          if (!rows.length) return [];
          headers = rows[0].map(h => h.trim());
          return rows.slice(1).map(r => {
            const obj = {}; headers.forEach((h, idx) => obj[h] = r[idx] !== undefined ? r[idx] : ''); return obj;
          });
        };

        const generateImagePaths = (row) => {
          const hasImg = (row['æ˜¯å¦æœ‰å›¾'] || '').trim() === '1';
          if (!hasImg) return [];
          let rawStr = row['å›¾ç‰‡'] || '';
          let count = 0;
          if (rawStr.trim()) count = rawStr.split(',').filter(x => x.trim()).length;
          if (count <= 0) return [];
          const paths = [`images/${row['id']}.png`];
          for (let k = 1; k < count; k++) { paths.push(`images/${row['id']}(${k}).png`); }
          return paths;
        };

        const processData = (csvRows) => {
          let mappedData = csvRows
            .filter(r => r['çŠ¶æ€'] === 'å¯å±•ç¤º' && r['id'])
            .map(r => ({
              id: r['id'],
              title: r['æ ‡é¢˜'] || 'æ— æ ‡é¢˜',
              content: (r['ç•™è¨€'] || '').trim(),
              displayTime: formatRelativeTime(r['æ—¥æœŸ']),
              fullTime: r['æ—¥æœŸ'] || '',
              images: generateImagePaths(r),
              isNew: (r['æ—¥æœŸ'] || '').includes('2025/12/03')
            }));

          allRawMessages.value = shuffleArray(mappedData);
          applyFilter();
        };

        const applyFilter = () => {
          let res = allRawMessages.value;
          if (onlyHasImage.value) { res = res.filter(m => m.images.length > 0); }
          if (searchQuery.value.trim()) {
            const q = searchQuery.value.toLowerCase();
            res = res.filter(m => m.title.toLowerCase().includes(q) || m.content.toLowerCase().includes(q));
          }
          filteredAllMessages.value = res;
          if (!isAutoRefresh.value) {
            updateDisplayedList();
          } else {
            currentLimit.value = PAGE_SIZE_INIT;
            displayedList.value = filteredAllMessages.value.slice(0, currentLimit.value);
          }
        };

        const resetPagination = () => {
          currentLimit.value = PAGE_SIZE_INIT;
          applyFilter();
          if (!isAutoRefresh.value) window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const toggleImageOnly = () => {
          onlyHasImage.value = !onlyHasImage.value;
          resetPagination();
        };

        const updateDisplayedList = () => { displayedList.value = filteredAllMessages.value.slice(0, currentLimit.value); };

        const loadMore = () => {
          if (isAutoRefresh.value) return;
          if (displayedList.value.length >= filteredAllMessages.value.length) return;
          currentLimit.value += PAGE_SIZE_MORE;
          updateDisplayedList();
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ‰‹åŠ¨/è‡ªåŠ¨ éšæœºåˆ·æ–° ---
        const reShuffleDisplay = () => {
          allRawMessages.value = shuffleArray(allRawMessages.value);
          applyFilter();
          currentLimit.value = PAGE_SIZE_INIT;
          displayedList.value = filteredAllMessages.value.slice(0, currentLimit.value);
          window.scrollTo({ top: 0, behavior: 'smooth' });

          // ä¿®å¤è¿›åº¦æ¡é€»è¾‘ï¼šå¼ºåˆ¶ç§»é™¤å†æ·»åŠ ï¼Œè§¦å‘ keyframes é‡æ–°æ’­æ”¾
          if (isAutoRefresh.value) {
            showProgressBar.value = false;
            nextTick(() => {
              // å¼ºåˆ¶é‡ç»˜
              showProgressBar.value = true;
            });
          }
        };

        const manualRefresh = () => {
          reShuffleDisplay();
        };

        const toggleAutoRefresh = () => {
          isAutoRefresh.value = !isAutoRefresh.value;
          if (isAutoRefresh.value) {
            // å¼€å¯
            showProgressBar.value = true;
            autoRefreshTimer = setInterval(() => {
              reShuffleDisplay();
            }, 60000); // 60ç§’
          } else {
            // å…³é—­
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            showProgressBar.value = false;
          }
        };

        onMounted(() => {
          const observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) loadMore(); }, { rootMargin: '100px' });
          if (loadSentinel.value) observer.observe(loadSentinel.value);
          loadCSV();
        });

        onUnmounted(() => {
          if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        });

        const totalFilteredCount = computed(() => filteredAllMessages.value.length);
        const hasMore = computed(() => displayedList.value.length < filteredAllMessages.value.length);

        // --- CSV & File ---
        const loadCSV = (forceReload = false) => {
          const url = `datacvs.csv?t=${Date.now()}`;
          fetch(url).then(r => { if (!r.ok) throw new Error("File not found"); return r.text(); })
            .then(text => { processData(parseCSV(text)); showFilePicker.value = false; })
            .catch(err => {
              if (!forceReload) {
                const embedEl = document.getElementById('csv-embed');
                if (embedEl && embedEl.textContent.trim()) { processData(parseCSV(embedEl.textContent)); if (window.location.protocol === 'file:') showFilePicker.value = true; }
                else { showFilePicker.value = true; }
              } else { showFilePicker.value = true; }
            });
        };
        const handleFileUpload = (e) => {
          const file = e.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => { processData(parseCSV(ev.target.result)); showFilePicker.value = false; };
          reader.readAsText(file, 'utf-8');
        };
        const handleImgError = (e) => { if (e.target.dataset.tried) return; e.target.dataset.tried = '1'; if (e.target.src.includes('.png')) e.target.src = e.target.src.replace('.png', '.jpg'); };

        // --- å¼¹çª—é€»è¾‘ ---
        const currentMsg = ref(null);
        const lightboxImages = ref([]);
        const currentLightboxIndex = ref(0);
        const openDetail = (msg) => {
          if (isAutoRefresh.value) return;
          currentMsg.value = msg; document.body.style.overflow = 'hidden';
        };
        const closeDetail = () => { currentMsg.value = null; document.body.style.overflow = ''; };
        const openLightbox = (imgs, idx) => { lightboxImages.value = imgs; currentLightboxIndex.value = idx; document.body.style.overflow = 'hidden'; };
        const closeLightbox = () => { lightboxImages.value = []; if (!currentMsg.value) document.body.style.overflow = ''; };
        const nextImage = () => currentLightboxIndex.value = (currentLightboxIndex.value + 1) % lightboxImages.value.length;
        const prevImage = () => currentLightboxIndex.value = (currentLightboxIndex.value - 1 + lightboxImages.value.length) % lightboxImages.value.length;

        window.addEventListener('keydown', (e) => {
          if (lightboxImages.value.length) { if (e.key === 'Escape') closeLightbox(); if (e.key === 'ArrowRight') nextImage(); if (e.key === 'ArrowLeft') prevImage(); }
          else if (currentMsg.value && e.key === 'Escape') closeDetail();
        });

        return {
          searchQuery, onlyHasImage, showFilePicker, loadSentinel,
          displayedList, totalFilteredCount, hasMore,
          resetPagination, loadCSV, handleFileUpload, handleImgError, toggleImageOnly,
          currentMsg, openDetail, closeDetail,
          lightboxImages, currentLightboxIndex, openLightbox, closeLightbox, nextImage, prevImage,
          // æ–°å¢æ§åˆ¶
          isAutoRefresh, toggleAutoRefresh, manualRefresh, showProgressBar
        };
      }
    }).mount('#app');
  </script>
</body>

</html>