<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç•™è¨€å¢™ Â· å°ç¡®å¹¸</title>
    <style>
      :root{
        --candy-50:#fff7f9;--candy-100:#ffeaf0;--candy-300:#ffafc6;--candy-500:#ff5c87;--candy-700:#d42757;
        --sky-100:#e6f7ff;--sky-300:#aee3ff;--sky-500:#6bc7ff;--sky-700:#3aa6e6;
        --text:#2b2b2b;--muted:#727272;--card:#ffffff;--border:#ffd1df;
      }
      *{box-sizing:border-box}
      html,body{height:100%; overflow-x:hidden;}
      body{margin:0;font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text)}
      .bg-candy{background:radial-gradient(1200px 400px at 10% -10%, var(--candy-100) 0%, transparent 40%),radial-gradient(800px 300px at 90% 0%, var(--sky-100) 0%, transparent 40%),linear-gradient(180deg,#fff 0%, var(--candy-50) 100%)}
      .bubble{position:absolute;border-radius:50%;filter:blur(1px);opacity:.65}
      .bubble.b1{width:200px;height:200px;background:var(--candy-300);top:8%;left:-60px}
      .bubble.b2{width:160px;height:160px;background:var(--sky-300);bottom:10%;right:-50px}
      .bubble.b3{width:120px;height:120px;background:var(--candy-100);bottom:35%;left:-40px}
      .container{max-width:1100px;width:100%;margin:0 auto;padding:0 20px}
      .header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--candy-100)}
      .header-bar{display:flex;align-items:center;gap:12px;padding:14px 20px}
      .logo{width:48px;height:48px;display:grid;place-items:center;border-radius:16px;background:linear-gradient(135deg,var(--candy-300),var(--sky-300));box-shadow:0 6px 16px rgba(255,92,135,.2)}
      .title{font-size:24px;font-weight:700;color:#b3224c}
      .subtitle{font-size:12px;color:var(--muted)}
      .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:18px 0}
      .input{width:280px;max-width:100%;padding:10px 14px;border-radius:16px;border:1px solid var(--border);background:#fff}
      .checkbox{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#494949}
      .masonry{column-count:1;column-gap:18px;width:100%}
      @media(min-width:760px){.masonry{column-count:2}}
      @media(min-width:1160px){.masonry{column-count:3}}
      .card{position:relative;background:var(--card);border-radius:24px;box-shadow:0 10px 30px rgba(255,92,135,.18);overflow:hidden;animation:fadeIn .35s ease;display:inline-block;width:100%;break-inside:avoid;margin:0 0 18px}
      @keyframes fadeIn{from{opacity:.0;transform:translateY(6px)}to{opacity:1;transform:none}}
      .sticker{position:absolute;top:-14px;left:18px;transform:rotate(-6deg)}
      .badge{display:inline-block;padding:6px 10px;border-radius:14px;background:linear-gradient(135deg,var(--candy-300),var(--sky-300));border:2px dashed rgba(255,172,200,.65);font-size:12px;color:#444}
      .clip-corner{clip-path:polygon(0 0, calc(100% - 24px) 0, 100% 24px, 100% 100%, 0 100%)}
      .card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
      .card-title{font-size:18px;font-weight:600;color:#8c0f37;margin:0}
      .card-date{font-size:12px;color:var(--muted);margin:4px 0 0}
      .card-status{padding:4px 8px;border-radius:10px;background:#fff0f5;color:#a51743;border:1px solid var(--border);font-size:12px}
      .card-body{padding:18px}
      .msg{white-space:pre-wrap;line-height:1.7;margin-top:10px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
      .gallery{padding:0 0 12px}
      .frame{position:relative;height:240px;border-radius:16px;overflow:hidden;border:1px solid var(--border);background:#fff;width:92%;margin:8px auto 12px}
      .images{position:relative;width:100%;height:100%}
      .image-wrap{position:absolute;inset:0;opacity:0;transition:opacity .25s ease;pointer-events:none}
      .image-wrap.active{opacity:1;pointer-events:auto}
      .image-wrap img{width:100%;height:100%;object-fit:cover;border-radius:0}
      .controls{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 8px;pointer-events:none}
      .btn{pointer-events:auto;background:#ffffffcc;border:1px solid var(--border);color:#8c0f37;border-radius:50%;width:34px;height:34px;display:grid;place-items:center}
      .dots{position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;justify-content:center}
      .dot{width:8px;height:8px;border-radius:999px;background:#ffffffcc;border:1px solid var(--border)}
      .dot.active{background:#ffeff5;border-color:#ffb8cf}
      .hint{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:16px;background:#fff0f5;border:1px solid var(--border);color:#a51743;font-size:13px}
      .hidden{display:none}
      .action{display:inline-block;padding:8px 12px;border-radius:14px;background:#fff;border:1px solid var(--border);color:#8c0f37}
      .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1001}
      .overlay.show{display:grid;place-items:center}
      .modal{width:min(860px,94vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.18)}
      .modal-head{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid #f3d9e3}
      .modal-title{font-size:20px;font-weight:700;color:#8c0f37;margin:0}
      .modal-date{font-size:12px;color:#747474;margin:6px 0 0}
      .modal-body{padding:12px 18px 18px}
      .modal-msg{white-space:pre-wrap;line-height:1.8;margin-top:10px}
      .modal-close{background:#fff;border:1px solid #f3d9e3;color:#8c0f37;width:34px;height:34px;border-radius:10px}
      @media(max-width:768px){
        .container{padding:0 12px}
        .header-bar{padding:12px 14px}
        .logo{width:42px;height:42px}
        .title{font-size:clamp(18px,5.2vw,22px)}
        .subtitle{font-size:12px}
        .filters{margin:12px 0}
        .input{width:100%}
        .masonry{column-gap:12px}
        .card{margin:0 0 14px}
        .card-body{padding:14px}
        .frame{height:auto;aspect-ratio:16/9;width:100%;margin:8px auto 10px}
        .btn{width:32px;height:32px}
        .dots{bottom:6px}
      }
      @media(max-width:420px){
        .logo{width:38px;height:38px}
        .title{font-size:clamp(17px,6vw,21px)}
        .badge{font-size:11px}
        .card-title{font-size:16px}
      }
      .imgbox-body{position:relative;display:grid;place-items:center}
      .fullimg{max-width:94vw;max-height:92vh;object-fit:contain;background:#fff;border-radius:12px}
      .imgbox-close{position:absolute;top:12px;right:12px}
    </style>
  </head>
  <body class="bg-candy" style="min-height:100vh">
    <div class="bubble b1"></div>
    <div class="bubble b2"></div>
    <div class="bubble b3"></div>

    <header class="header">
      <div class="container header-bar">
        <div class="logo"><span style="font-size:22px">ğŸ§¸</span></div>
        <div style="flex:1">
          <div class="title">å°ç¡®å¹¸ç•™è¨€å¢™</div>
          <div class="subtitle">ç”¨ä¸€å¼ å¡ç‰‡ï¼Œç•™ä½ä»Šå¤©çš„æ¸©æŸ”å’Œå…‰</div>
        </div>
      </div>
    </header>

    <main class="container" style="padding:20px 0 24px">
      <section class="filters">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <input id="search" type="search" placeholder="æœç´¢æ ‡é¢˜æˆ–ç•™è¨€å…³é”®è¯â€¦" class="input" />
          <label class="checkbox"><input id="onlyWithImages" type="checkbox" /> ä»…æ˜¾ç¤ºæœ‰å›¾</label>
          <button id="reloadBtn" type="button" class="action">åˆ·æ–°æ•°æ®</button>
        </div>
        <div id="subtitle" class="subtitle"></div>
      </section>

      <section id="wall" class="masonry"></section>
      <div id="sentinel" style="height:1px"></div>
      <section id="error" class="card-body hidden">
        <div class="hint" style="margin-top:8px">
          <span>âš ï¸</span>
          <span>CSV åŠ è½½å¤±è´¥ã€‚ä½ å¯ä»¥ç‚¹ä¸‹é¢æŒ‰é’®æ‰‹åŠ¨é€‰æ‹© datacvs.csv</span>
        </div>
        <div style="margin-top:10px"><input id="filePicker" type="file" accept=".csv" /></div>
      </section>
    </main>

    <div id="overlay" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <div>
            <h3 class="modal-title"></h3>
            <p class="modal-date"></p>
          </div>
          <button class="modal-close" aria-label="å…³é—­">Ã—</button>
        </div>
        <div class="modal-body">
          <p class="modal-msg"></p>
          <div class="gallery" id="modal-gallery" hidden>
            <div class="frame">
              <div class="images"></div>
              <div class="controls">
                <button class="btn prev" aria-label="ä¸Šä¸€å¼ ">â€¹</button>
                <button class="btn next" aria-label="ä¸‹ä¸€å¼ ">â€º</button>
              </div>
              <div class="dots"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="imgbox" class="overlay">
      <div class="imgbox-body">
        <button class="modal-close imgbox-close" aria-label="å…³é—­">Ã—</button>
        <img class="fullimg" alt="æŸ¥çœ‹åŸå›¾" />
      </div>
    </div>

    <template id="card-template">
      <article class="card">
        <div class="sticker"><span class="badge">ä»Šæ—¥å°ç¡®å¹¸</span></div>
        <div class="clip-corner" style="background:#fff">
          <div class="card-body">
            <div class="card-head">
              <div>
                <h3 class="card-title"></h3>
                <p class="card-date"></p>
              </div>
            </div>
            <p class="msg"></p>
          </div>
          <div class="gallery" hidden>
            <div class="frame">
              <div class="images"></div>
              <div class="controls">
                <button class="btn prev" aria-label="ä¸Šä¸€å¼ ">â€¹</button>
                <button class="btn next" aria-label="ä¸‹ä¸€å¼ ">â€º</button>
              </div>
              <div class="dots"></div>
            </div>
          </div>
        </div>
      </article>
    </template>

    <script id="csv-embed" type="text/plain">id,æ ‡é¢˜,æ—¥æœŸ,ç•™è¨€,å›¾ç‰‡,çŠ¶æ€,æ˜¯å¦æœ‰å›¾
20251203001,111,2025/12/03 09:31,å¸Œæœ›æœ‰ä¸€å¥èƒ½è®©ä½ æˆ–ä½ æƒ³ç¥ç¦çš„äººæ„Ÿåˆ°æ¸©æš– ğŸŒ¸,7å¤ªä¹™_çˆ±ç»™ç½‘_aigei_com.png,å¯å±•ç¤º,1
20251203002,222,2025/12/03 09:31,ä»Šå¤©æœ‰å¥½å¥½åƒé¥­å—ï¼Ÿè®°å¾—ç…§é¡¾å¥½è‡ªå·±ï¼Œä½ å¿™ç¢Œçš„æ ·å­å¾ˆæ£’ï¼Œä½†ä¹Ÿè¦è®°å¾—è®©å¿ƒä¼‘æ¯ä¸€ä¸‹ã€‚æ™šå®‰ï¼Œæ˜å¤©è§ã€‚,,å¯å±•ç¤º,0
20251203003,333,2025/12/03 09:31,ç”Ÿæ´»æˆ–è®¸å¿™ç¢Œï¼Œä½†åˆ«å¿˜äº†åœä¸‹è„šæ­¥ï¼Œæ„Ÿå—å¾®é£å’Œèº«è¾¹çš„å°ç¡®å¹¸ã€‚,"7å¤ªä¹™_çˆ±ç»™ç½‘_aigei_com.png,wechat_2025-11-12_152347_145.png",å¯å±•ç¤º,1
20251203004,444,2025/12/03 09:31," ä»Šå¤©ä¹Ÿæ˜¯é—ªé—ªå‘å…‰çš„ä¸€å¤©ï¼åˆ«å¿˜äº†ä½ å€¼å¾—æ‰€æœ‰ç¾å¥½ï¼ŒåŠ æ²¹å“¦ï¼ ç§‹é£ææ¥æˆ‘çš„é—®å€™ï¼Œæ„¿ä½ å¿ƒæœ‰æ‰€ä¾ï¼Œå¿™æœ‰æ‰€è·ï¼Œçˆ±æœ‰æ‰€å¾—ï¼Œå¹³å‡¡æ—¥å­é‡Œå……æ»¡å°ç¡®å¹¸ã€‚æ„¿ä½ çš„ä¸€å¤©ï¼Œæœ‰æš–é˜³çš„æ¸©æŸ”ï¼Œä¹Ÿæœ‰å¾®é£çš„æ¸…çˆ½ï¼Œæ›´æœ‰å‘è‡ªå†…å¿ƒçš„å–œæ‚¦ã€‚æ™šå®‰å¥½æ¢¦ã€‚",,å¯å±•ç¤º,0
20251203005,555,2025/12/03 09:31,æ„¿ä½ ä»Šå¤©ä¹Ÿè¢«é˜³å…‰æ¸©æŸ”æ‹¥æŠ±ï¼Œè¢«å¾®é£è½»è½»é—®å€™ã€‚è®°å¾—å¥½å¥½åƒé¥­ï¼Œå¥½å¥½çˆ±è‡ªå·±å‘€ã€‚ä¸ç®¡ä¸–ç•Œå¤šä¹ˆå–§åš£ï¼Œæ€»æœ‰äººåœ¨ä½ ä¸çŸ¥é“çš„åœ°æ–¹ï¼Œé»˜é»˜æƒ¦è®°ç€ä½ ï¼Œä¸ºä½ ç¥ç¦ã€‚ä»Šå¤©è¾›è‹¦äº†ï¼åˆ«å¿˜äº†ä½ é—ªé—ªå‘å…‰çš„æ ·å­ï¼Œç‰¹åˆ«å€¼å¾—ä¸–é—´æ‰€æœ‰ç¾å¥½ã€‚å¶å°”åœä¸‹æ¥ä¹Ÿæ²¡å…³ç³»ï¼Œä¼‘æ¯æ˜¯ä¸ºäº†æ›´å¥½åœ°å‡ºå‘ã€‚åˆ«å¿˜äº†ï¼Œæˆ‘ä¸€ç›´éƒ½åœ¨ã€‚,,å¯å±•ç¤º,0
20251203006,666,2025/12/03 09:31,æ¸…æ™¨çš„é˜³å…‰æ›¿æˆ‘é—®å€™ä½ ï¼Œæ„¿ä½ ä»Šå¤©è¢«å°äº‹ç‚¹äº®ï¼Œè¢«æ¸©æŸ”åŒ…å›´ã€‚è®°å¾—å¥½å¥½åƒé¥­ï¼Œä½ å€¼å¾—æ‰€æœ‰ç¾å¥½,wechat_2025-11-14_164335_781.png,å¯å±•ç¤º,1
20251203007,777,2025/12/03 09:31," æ—¥å­å¿™å¿™ç¢Œç¢Œï¼Œè®°å¾—ç…§é¡¾å¥½è‡ªå·±ã€‚æ„¿ä½ çœ¼ä¸­æœ‰å…‰ï¼Œå¿ƒä¸­æœ‰çˆ±ï¼Œå¹³å®‰å–œä¹ã€‚",,å¯å±•ç¤º,0
20251203008,888,2025/12/03 09:31,"ç§‹é£æ¸èµ·ï¼Œè®°å¾—æ·»è¡£ã€‚æ„¿ä½ çš„ä¸€å¤©éƒ½è¢«å°äº‹æ¸©æš–ï¼Œè¢«å–„æ„åŒ…å›´ã€‚ ä¸ç®¡ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Œéƒ½åˆ«å¿˜äº†ä½ ç‰¹åˆ«å¥½ï¼Œç‰¹åˆ«å€¼å¾—ã€‚æˆ‘æ°¸è¿œæ˜¯ä½ çš„å¤´å·ç²‰ä¸ï¼å˜¿ï¼Œçªç„¶å¾ˆæƒ³ä½ ã€‚å¸Œæœ›ä½ æ­¤åˆ»æ­£è¢«å¿«ä¹çš„äº‹æƒ…å æ®ï¼Œè„¸ä¸Šæœ‰ç¬‘å®¹ã€‚ä¹Ÿè®¸æˆ‘ä»¬å¶å°”ä¼šé”™è¿‡å½¼æ­¤çš„æ¶ˆæ¯ï¼Œä½†ä½ çŸ¥é“çš„ï¼Œæˆ‘ä¸€ç›´åœ¨ã€‚ ç”Ÿæ´»æˆ–è®¸æœ‰ç‚¹å¿™ä¹±ï¼Œä½†è¯·è®°å¾—ç»™è‡ªå·±ç•™ä¸€ä¸ªå–˜æ¯å’Œå¾®ç¬‘çš„é—´éš™ã€‚ç¥ä½ ä»Šå¤©é¡ºåˆ©ã€‚
",,å¯å±•ç¤º,0
20251203009,999,2025/12/03 09:31," æ„¿ä½ ä»Šæ—¥ä¹Ÿæœ‰é˜³å…‰èˆ¬çš„ç¬‘å®¹ï¼Œå’Œå¾®é£èˆ¬è½»ç›ˆçš„å¥½å¿ƒæƒ…ã€‚è®°å¾—å¥½å¥½åƒé¥­ï¼Œå¥½å¥½ä¼‘æ¯ï¼Œä½ å€¼å¾—è¢«æ¸©æŸ”ä»¥å¾…ã€‚ ",,å¯å±•ç¤º,0
20251203010,110,2025/12/03 09:31," æ—¥å­å¿™å¿™ç¢Œç¢Œï¼Œè®°å¾—ç…§é¡¾å¥½è‡ªå·±ã€‚æ„¿ä½ çœ¼é‡Œæœ‰å…‰ï¼Œå¿ƒä¸­æœ‰çˆ±ï¼Œä¸€åˆ‡ç¾å¥½éƒ½ä¼šå¦‚æœŸè€Œè‡³ã€‚",,å¯å±•ç¤º,0</script>

    <script>
      function parseCSV(text){
        const rows=[];const headers=[];let i=0;let field='';let row=[];let inQuotes=false;let lastWasQuote=false;
        function pushField(){row.push(field);field='';}
        function pushRow(){rows.push(row);row=[];}
        while(i<text.length){const c=text[i++];
          if(inQuotes){
            if(c==='"'){
              if(text[i]==='"'){field+='"';i++;} else {inQuotes=false;lastWasQuote=true;}
            } else {field+=c;lastWasQuote=false;}
          } else {
            if(c==='"'){inQuotes=true;}
            else if(c===','){pushField();}
            else if(c==='\n'){
              pushField(); if(row.length>0) pushRow();
            } else if(c==='\r'){ }
            else {field+=c;}
          }
        }
        if(field.length>0 || lastWasQuote){pushField();}
        if(row.length){pushRow();}
        if(!rows.length) return [];
        rows[0].forEach(h=>headers.push(String(h).trim()));
        return rows.slice(1).map(r=>{
          const obj={};
          for(let j=0;j<headers.length;j++) obj[headers[j]]=r[j]!==undefined?r[j]:'';
          return obj;
        });
      }

      (function(){
        const csvUrl='datacvs.csv';
        const wallEl=document.getElementById('wall');
        const tpl=document.getElementById('card-template');
        const searchEl=document.getElementById('search');
        const withImagesEl=document.getElementById('onlyWithImages');
        const errorEl=document.getElementById('error');
        const picker=document.getElementById('filePicker');
        const reloadBtn=document.getElementById('reloadBtn');
        const subtitleEl=document.getElementById('subtitle');
        let allRows=[];
        let dataSource='';
        let lastLoaded='';
        let filteredRows=[];
        let shuffledRows=[];
        let visibleCount=50;
        let lastRenderedIndex=0;
        let io;

        function parseImageCount(cell){
          if(!cell) return 0; const s=String(cell).trim(); if(!s) return 0; return s.split(',').map(x=>x.trim()).filter(Boolean).length;
        }
        function computeImagePaths(id,count){
          if(count<=0) return [];
          const paths=[];
          if(count>=1) paths.push(`images/${id}.png`);
          for(let i=1;i<count;i++) paths.push(`images/${id}(${i}).png`);
          return paths;
        }
        function onImgError(e){ const el=e.currentTarget; if(el.dataset.fallbackTried==='1') return; el.dataset.fallbackTried='1'; el.src=el.src.replace(/\.png($|\?)/,'.jpg$1'); }
        function clearWall(){ wallEl.innerHTML=''; }
        const overlay=document.getElementById('overlay');
        const modalGallery=document.getElementById('modal-gallery');
        const mt=document.querySelector('.modal-title');
        const md=document.querySelector('.modal-date');
        const mm=document.querySelector('.modal-msg');
        const mClose=document.querySelector('.modal-close');
        const imgbox=document.getElementById('imgbox');
        const imgboxImg=imgbox.querySelector('.fullimg');
        const imgboxClose=imgbox.querySelector('.imgbox-close');
        let imgboxPaths=[]; let imgboxIdx=0;
        function showImgbox(){ if(!imgboxPaths.length) return; imgboxImg.src=imgboxPaths[imgboxIdx]; }
        function openImgbox(paths,start){ imgboxPaths=paths.slice(); imgboxIdx=Math.max(0, Math.min(paths.length-1, start||0)); imgboxImg.dataset.fallback=''; imgboxImg.onerror=()=>{ if(imgboxImg.dataset.fallback==='') { imgboxImg.dataset.fallback='1'; imgboxImg.src=imgboxImg.src.replace(/\.png($|\?)/,'.jpg$1'); } }; showImgbox(); imgbox.classList.add('show'); }
        function closeImgbox(){ imgbox.classList.remove('show'); }
        imgboxClose.addEventListener('click', closeImgbox);
        imgbox.addEventListener('click', e=>{ if(e.target===imgbox) closeImgbox(); });
        document.addEventListener('keydown', e=>{ if(!imgbox.classList.contains('show')) return; if(e.key==='Escape') closeImgbox(); if(e.key==='ArrowRight') { imgboxIdx=(imgboxIdx+1)%imgboxPaths.length; showImgbox(); } if(e.key==='ArrowLeft') { imgboxIdx=(imgboxIdx-1+imgboxPaths.length)%imgboxPaths.length; showImgbox(); } });
        function showModal(row){
          mt.textContent=String(row.æ ‡é¢˜||'').trim()||`æ— æ ‡é¢˜ Â· ${row.id}`;
          md.textContent=String(row.æ—¥æœŸ||'');
          mm.textContent=String(row.ç•™è¨€||'').trim();
          const hasImg=String(row.æ˜¯å¦æœ‰å›¾||'').trim()==='1';
          const count=hasImg?parseImageCount(row.å›¾ç‰‡):0;
          const paths=computeImagePaths(row.id,count);
          const imagesEl=modalGallery.querySelector('.images');
          const dotsEl=modalGallery.querySelector('.dots');
          imagesEl.innerHTML=''; dotsEl.innerHTML='';
          if(paths.length>0){
            modalGallery.hidden=false;
            paths.forEach((src,i)=>{ const wrap=document.createElement('div'); wrap.className='image-wrap'+(i===0?' active':''); wrap.dataset.idx=String(i); const img=document.createElement('img'); img.src=src; img.alt=`å›¾ç‰‡ ${row.id}`; img.addEventListener('error',onImgError); img.addEventListener('click', (ev)=>{ ev.stopPropagation(); const start=Number(wrap.dataset.idx|| i); openImgbox(paths, start); }); wrap.appendChild(img); imagesEl.appendChild(wrap); const dot=document.createElement('div'); dot.className='dot'+(i===0?' active':''); dot.dataset.idx=String(i); dotsEl.appendChild(dot); });
            initViewer(modalGallery);
          } else { modalGallery.hidden=true; }
          overlay.classList.add('show');
        }
        function hideModal(){ overlay.classList.remove('show'); }
        mClose.addEventListener('click',hideModal);
        overlay.addEventListener('click',e=>{ if(e.target===overlay) hideModal(); });
        function initViewer(gallery){
          const wraps=[...gallery.querySelectorAll('.image-wrap')];
          const dots=[...gallery.querySelectorAll('.dot')];
          let idx=0;
          function show(i){ idx=(i+wraps.length)%wraps.length; wraps.forEach((w,j)=>w.classList.toggle('active', j===idx)); dots.forEach((d,j)=>d.classList.toggle('active', j===idx)); gallery.dataset.currentIndex=String(idx); }
          gallery.querySelector('.prev').addEventListener('click',()=>show(idx-1));
          gallery.querySelector('.next').addEventListener('click',()=>show(idx+1));
          dots.forEach(d=>d.addEventListener('click',()=>show(Number(d.dataset.idx||'0'))));
          show(0);
          const frame=gallery.querySelector('.frame');
          if(frame){ frame.addEventListener('click',(ev)=>{ ev.stopPropagation(); const imgs=[...gallery.querySelectorAll('.image-wrap img')].map(i=>i.src); const start=Number(gallery.dataset.currentIndex||'0'); openImgbox(imgs,start); }); }
        }
        function applyFilters(){ const q=searchEl.value.trim().toLowerCase(); const onlyImg=withImagesEl.checked; filteredRows=allRows.filter(r=>String(r.çŠ¶æ€).trim()==='å¯å±•ç¤º').filter(r=>{ if(!q) return true; const text=`${r.æ ‡é¢˜||''} ${r.ç•™è¨€||''}`.toLowerCase(); return text.includes(q); }).filter(r=>{ if(!onlyImg) return true; return String(r.æ˜¯å¦æœ‰å›¾||'').trim()==='1'; }); shuffledRows=shuffle(filteredRows.slice()); visibleCount=50; renderInit(); }
        function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
        function buildCard(row){
          const { id, æ ‡é¢˜, æ—¥æœŸ, ç•™è¨€, å›¾ç‰‡, çŠ¶æ€, æ˜¯å¦æœ‰å›¾ } = row;
          const node=tpl.content.cloneNode(true);
          const root=node.querySelector('article');
          root.querySelector('.card-title').textContent=String(æ ‡é¢˜||'').trim()||`æ— æ ‡é¢˜ Â· ${id}`;
          root.querySelector('.card-date').textContent=String(æ—¥æœŸ||'');
          root.querySelector('.msg').textContent=String(ç•™è¨€||'').trim();
          const hasImg=String(æ˜¯å¦æœ‰å›¾||'').trim()==='1';
          const count=hasImg?parseImageCount(å›¾ç‰‡):0;
          const paths=computeImagePaths(id,count);
          const gallery=root.querySelector('.gallery');
          const imagesEl=gallery.querySelector('.images');
          const dotsEl=gallery.querySelector('.dots');
          if(paths.length>0){
            gallery.hidden=false;
            paths.forEach((src,i)=>{ const wrap=document.createElement('div'); wrap.className='image-wrap'+(i===0?' active':''); wrap.dataset.idx=String(i); const img=document.createElement('img'); img.src=src; img.alt=`å›¾ç‰‡ ${id}`; img.addEventListener('error',onImgError); img.addEventListener('click', (ev)=>{ ev.stopPropagation(); const start=Number(wrap.dataset.idx|| i); openImgbox(paths, start); }); wrap.appendChild(img); imagesEl.appendChild(wrap); const dot=document.createElement('div'); dot.className='dot'+(i===0?' active':''); dot.dataset.idx=String(i); dotsEl.appendChild(dot); });
            initViewer(gallery);
          }
          root.addEventListener('click', (e)=>{ if(e.target.closest('.btn') || e.target.closest('.dot')) return; showModal(row); });
          return node;
        }
        function clearWall(){ wallEl.innerHTML=''; lastRenderedIndex=0; }
        function renderChunk(start,end){ const to=Math.min(end, shuffledRows.length); for(let i=start;i<to;i++){ wallEl.appendChild(buildCard(shuffledRows[i])); } lastRenderedIndex=to; }
        function renderInit(){ clearWall(); renderChunk(0, visibleCount); updateSubtitle(); ensureObserver(); }
        function addMore(){ if(lastRenderedIndex>=shuffledRows.length) return; renderChunk(lastRenderedIndex, lastRenderedIndex+10); updateSubtitle(); }
        function updateSubtitle(){ subtitleEl.textContent=`æ¥æºï¼š${dataSource||'æœªçŸ¥'} Â· æ˜¾ç¤ºï¼š${lastRenderedIndex}/${shuffledRows.length} Â· åŠ è½½ï¼š${lastLoaded||''}`; }
        function ensureObserver(){ if(io) io.disconnect(); io=new IntersectionObserver(entries=>{ entries.forEach(en=>{ if(en.isIntersecting){ addMore(); if(lastRenderedIndex>=shuffledRows.length) io.disconnect(); } }); }); io.observe(document.getElementById('sentinel')); }
        
        searchEl.addEventListener('input',applyFilters);
        withImagesEl.addEventListener('change',applyFilters);

        function tryEmbedded(){
          const el=document.getElementById('csv-embed');
          if(!el) return false; const text=el.textContent||''; if(!text.trim()) return false; allRows=parseCSV(text).filter(r=>r&&r.id); dataSource='å†…åµŒ'; lastLoaded=new Date().toLocaleString(); applyFilters(); return true;
        }

        function showPicker(){ errorEl.classList.remove('hidden'); picker.addEventListener('change',()=>{
          const file=picker.files&&picker.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ allRows=parseCSV(String(reader.result)).filter(r=>r&&r.id); applyFilters(); errorEl.classList.add('hidden'); }catch(e){} }; reader.readAsText(file,'utf-8');
        }); }

        function loadCSV(noCache, forcePicker){
          const u = noCache ? `${csvUrl}?t=${Date.now()}` : csvUrl;
          fetch(u, { cache: 'no-store' }).then(r=>r.ok?r.text():Promise.reject()).then(t=>{
            allRows=parseCSV(t).filter(r=>r&&r.id);
            dataSource='æ–‡ä»¶';
            lastLoaded=new Date().toLocaleString();
            applyFilters();
          }).catch(()=>{
            if (forcePicker) { errorEl.classList.remove('hidden'); showPicker(); }
            else { if(!tryEmbedded()) { showPicker(); } }
          });
        }
        reloadBtn.addEventListener('click',()=>loadCSV(true, true));
        if (location.protocol === 'file:') {
          if(!tryEmbedded()) { errorEl.classList.remove('hidden'); showPicker(); }
        } else {
          loadCSV(false, false);
        }
      })();
    </script>
  </body>
  </html>
